name: Main

on:
  push:
    tags:
      - "*.*.*"
      - "*.*.*-zts"

jobs:
  create-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Export ZTS_SUFFIX (if zts is enabled)
        run: echo "ZTS_SUFFIX=`echo ${{ github.ref_name }} | grep 'zts' > /dev/null && echo '-zts' || echo ''` >> $GITHUB_ENV
      - name: "Fetch all existing tags"
        run: curl -L -s 'https://registry.hub.docker.com/v2/repositories/endava/php/tags?page_size=9999'|jq -r ".\"results\"[][\"name\"] | select(test( \"^[0-9]+.[0-9]+.[0-9]+${ZTS_SUFFIX}\$\"))" > existing_docker_tags.txt
      - name: "Store the current tag"
        run: echo ${{ github.ref_name }} > current_tag.txt
      - name: "Export PREVIOUS_PHP_VERSION environment variable"
        run: echo "PREVIOUS_PHP_VERSION=`cat existing_docker_tags.txt current_tag.txt | sort -n | uniq | grep -Fx -a1 ${{ github.ref_name }} | head -n 1`" >> $GITHUB_ENV
      - name: "Export the php -i of previous php version ${{ env.PREVIOUS_PHP_VERSION }}"
        run: docker run --rm endava/php:${{ env.PREVIOUS_PHP_VERSION }} php -i | sed '/^Environment$/,$d' > previous-php-i.txt
      - name: Generate Changelog
        run: docker run --rm -v `pwd`/previous-php-i.txt:/usr/src/app/previous-php-i.txt -v `pwd`/generate-changelog.php:/usr/src/app/generate-changelog.php endava/php:${{ github.ref_name }} php /usr/src/app/generate-changelog.php endava/php:${{ github.ref_name }} > RELEASE_NOTES.txt
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: RELEASE_NOTES.txt
